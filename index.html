<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多AI角色群聊</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100dvh;
            overflow: hidden;
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 900;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .container {
            display: flex;
            height: 100dvh;
            max-width: 1800px;
            margin: 0 auto;
            gap: 16px;
            padding: 16px;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .sidebar-right {
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .user-bar {
            background: #f0f4ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            font-size: 14px;
            color: #333;
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .item {
            background: #f5f5f5;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .item:hover {
            background: #e8e8e8;
        }

        .item.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .item-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .item-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .item-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
        .icon-btn { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; width: 32px; height: 32px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: background var(--transition), border-color var(--transition), transform var(--transition), color var(--transition); }
        .icon-btn:hover { background: var(--muted); }
        .icon-btn:active { transform: scale(0.98); }
        .icon-btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
        .icon-btn-danger { background: var(--danger-soft-bg); border-color: var(--danger-soft-border); color: var(--danger-soft-fg); }
        .icon-btn-danger:hover { background: var(--danger-soft-bg-hover); }
        .icon-btn-danger:active { background: var(--danger-soft-bg-active); }
        .more-wrap { position: relative; }
        .dropdown-menu { position: absolute; right: 0; top: 36px; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow-md); min-width: 120px; padding: 6px; z-index: 20; display: none; }
        .dropdown-menu.open { display: block; }
        .dropdown-item { padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 14px; color: var(--text); }
        .dropdown-item:hover { background: var(--muted); }
        .dropdown-item-danger { background: var(--danger-soft-bg); color: var(--danger-soft-fg); border: 1px solid var(--danger-soft-border); }
        .dropdown-item-danger:hover { background: var(--danger-soft-bg-hover); }
        .dropdown-item-danger:active { background: var(--danger-soft-bg-active); }
        .role-muted { color: color-mix(in oklab, var(--text) 55%, transparent); font-size: 0.9em; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-icon {
            display: inline-block;
            font-size: 16px;
            margin-right: 8px;
            line-height: 1;
        }

        .btn-text {
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            font-size: 12px;
            padding: 4px 8px;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            font-size: 12px;
            padding: 4px 8px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-header {
            padding: 18px 24px;
            border-bottom: 1px solid #e0e0e0;
            background: #f7f9ff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 0;
        }

        .chat-header-menu {
            font-weight: 600;
        }

        .chat-header-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .chat-header-info h2 {
            margin: 0;
            font-size: 20px;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header-subtitle {
            font-size: 12px;
            color: #6b7280;
            display: none;
        }

        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .chat-header-actions .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            padding: 0 16px;
        }

        .chat-header-actions .sidebar-toggle {
            border: 1px solid #d4d9ff;
            background: #eef1ff;
            color: #3f51b5;
        }

        .chat-header-left .sidebar-toggle,
        .chat-header-actions .sidebar-toggle {
            margin-right: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
        }

        /* 系统提示（元信息/上下文锚点）样式 */
        .system-message {
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            margin: 14px 0;
            line-height: 1.4;
            padding: 0 8px;
        }
        .system-message.system-info { color: #64748b; }
        .system-message.system-success { color: #16a34a; }
        .system-message.system-warning { color: #b45309; }
        .system-message.system-error { color: #b91c1c; }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-name {
            font-weight: 600;
            color: #333;
        }

        .message-time {
            font-size: 12px;
            color: #999;
        }

        .message-text {
            background: white;
            padding: 12px;
            border-radius: 8px;
            color: #333;
            line-height: 1.5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* 更轻量的流式加载外观 */
        .message.streaming { margin-bottom: 10px; }
        .message.streaming .message-header { display: none; }
        .message.streaming .message-avatar { width: 28px; height: 28px; font-size: 12px; }
        .message.streaming .message-text { background: transparent; box-shadow: none; padding: 2px 0; }

        .message.user .message-text {
            background: #667eea;
            color: white;
        }

        /* 同一条消息内的分组气泡容器 */
        .message-bubbles { display: flex; flex-direction: column; gap: 6px; }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: end;
            gap: 10px;
        }

        .chat-input textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            margin: auto;
        }

        .modal-header h3 {
            color: #333;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group.checkbox-inline label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 0;
        }

        .form-group.checkbox-inline input[type="checkbox"] {
            width: auto;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .typing-indicator {
            display: inline-block;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .agent-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            vertical-align: middle;
            margin-right: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .checkbox-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 10px;
        }

        .checkbox-item {
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input {
            width: auto;
        }

        .section-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 20px 0;
        }

        .config-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .config-toggle input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .config-section {
            padding: 15px;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .config-section.hidden {
            display: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sidebar, .sidebar-right {
            transition: all 0.3s ease;
        }

        .sidebar.hidden {
            width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
            box-shadow: none;
            
/* 保留 gap，使用负 margin 来“吃掉” gap
这个方案比较“取巧”，但也能用，并且改动较小。它利用了负 margin 可以“拉回”后续元素的特性来抵消 gap。

保留 .container 上的 gap: 16px;

修改您的“隐藏”状态： */

/* 关键: 添加一个与 gap 等值的负 margin 来“吃掉”它 */

/* 这个方案有风险!!!!!! */

/* 它在 gap 和 margin 之间创建了耦合。
如果将来您决定将 gap 从 16px 改为 24px，
必须记得同时修改隐藏类中的 margin-right: -24px，
否则布局会出错。 */
            margin-right: -16px;
        }

        .sidebar-right.hidden {
            width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
            box-shadow: none;
            margin-left: -16px;
        }

        .sidebar-toggle {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            margin-right: 10px;
            transition: all 0.2s;
        }

        .sidebar-toggle:hover {
            background: #f5f5f5;
        }

        @media (max-width: 1200px) {
            .container {
                gap: 10px;
                padding: 10px;
            }

            .sidebar {
                padding: 10px;
                width: 25vw;
                max-width: 280px;
            }

            .sidebar-right {
                padding: 10px;
                width: 28vw;
                max-width: 300px;
            }

            .sidebar.hidden {
                margin-right: -10px;
            }

            .sidebar-right.hidden {
                margin-left: -10px;
            }

        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                gap: 0;
                padding: 0;
            }

            .sidebar, .sidebar-right {
                position: fixed;
                height: calc(100dvh);
                border-radius: 0;
                z-index: 1000;
                transition: all 0.3s ease;
                width: 280px;
            }

            .sidebar {
                left: 0;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }

            .sidebar.hidden {
                width: 280px;
                padding: 20px;
                border: none;
                transform: translateX(-100%);
            }

            .sidebar-right {
                right: 0;
                box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            }

            .sidebar-right.hidden {
                width: 280px;
                padding: 20px;
                border: none;
                transform: translateX(100%);
            }

            .main-content {
                flex: 1;
                border-radius: 0;
                margin: 0;
            }

            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 8px 12px;
            }

            .chat-header {
                flex-direction: row;
                align-items: center;
                gap: 8px;
                padding: 12px 14px;
                flex-wrap: nowrap;
            }

            .chat-header-left {
                flex: 1 1 auto;
                min-width: 0;
            }

            .chat-header-actions {
                flex: 0 0 auto;
                display: flex;
                gap: 6px;
                white-space: nowrap;
            }

            .chat-header-actions .btn,
            .chat-header-actions .sidebar-toggle {
                flex: 0 0 auto;
                padding: 8px 12px;
            }

            .chat-header-actions .btn .btn-text { display: none; }
            .chat-header-actions .btn .btn-icon { margin-right: 0; }

            .chat-header-info h2 {
                font-size: 18px;
            }

            .chat-header-subtitle {
                font-size: 11px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 14px;
            }

            .chat-input {
                flex-direction: row;
                padding: 10px;
                gap: 5px;
            }

            .chat-input textarea {
                font-size: 14px;
                padding: 8px;
                max-height: 80px;
            }

            .modal-content {
                width: 95%;
                max-width: 500px;
                padding: 20px;
                max-height: 90vh;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0;
            }

            .sidebar, .sidebar-right {
                width: 75vw;
                height: calc(100dvh);
            }

            .chat-header {
                padding: 12px;
                gap: 10px;
                flex-wrap: nowrap;
            }

            .chat-messages {
                padding: 10px;
            }

            .message {
                margin-bottom: 12px;
                gap: 8px;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .message-name {
                font-size: 14px;
            }

            .message-text {
                padding: 8px;
                font-size: 14px;
            }

            .sidebar-toggle {
                padding: 6px 8px;
                font-size: 16px;
                margin-right: 0;
                padding: 8px 12px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 16px;
            }

            .chat-header-actions .btn,
            .chat-header-actions .sidebar-toggle {
                flex: 0 0 auto;
            }

            .chat-header-actions .btn .btn-text {
                display: none;
            }

            .chat-header-actions .btn .btn-icon {
                margin-right: 0;
            }

            .chat-header-info h2 {
                font-size: 16px;
            }

            .chat-header-subtitle {
                display: none;
            }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
            padding: 0;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease-out forwards;
        }

        @media (max-width: 768px) {
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .toast {
                min-width: unset;
            }
        }
        
        /* ===== Modern UI: Design Tokens ===== */
        :root {
            --app-bg: hsl(220 14% 97%);
            --panel: hsl(0 0% 100%);
            --text: hsl(224 71% 4%);
            --muted: hsl(220 14% 96%);
            --border: hsl(220 13% 91%);

            --brand: hsl(246 83% 60%);
            --brand-contrast: hsl(0 0% 100%);
            --success: hsl(160 84% 39%);
            --warning: hsl(36 100% 45%);
            --error: hsl(0 84% 60%);

            --radius: 12px;
            --radius-lg: 14px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 6px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);
            --transition: 200ms cubic-bezier(.2,.7,.2,1);
            --focus-ring: 0 0 0 3px color-mix(in oklab, var(--brand) 35%, transparent);
            --control-bg: hsl(0 0% 100%);

            --bubble-bg-ai: var(--panel);
            --bubble-bg-user: color-mix(in oklab, var(--brand) 18%, var(--panel));
            --bubble-fg-user: var(--text);

            /* Soft danger tokens for subtle destructive actions */
            --danger-soft-bg: hsl(0 100% 97%);
            --danger-soft-bg-hover: hsl(0 100% 95%);
            --danger-soft-bg-active: hsl(0 100% 93%);
            --danger-soft-border: hsl(0 92% 88%);
            --danger-soft-fg: hsl(0 70% 30%);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --app-bg: hsl(224 14% 10%);
                --panel: hsl(224 14% 12%);
                --text: hsl(0 0% 98%);
                --muted: hsl(224 14% 16%);
                --border: hsl(224 14% 22%);
                --control-bg: hsl(224 14% 16%);

                --shadow-sm: 0 2px 8px rgba(0,0,0,0.5);
                --shadow-md: 0 6px 16px rgba(0,0,0,0.55);
                --shadow-lg: 0 12px 32px rgba(0,0,0,0.6);

                --bubble-bg-ai: hsl(224 14% 16%);
                --bubble-bg-user: color-mix(in oklab, var(--brand) 26%, var(--panel));
                --bubble-fg-user: var(--text);

                /* Dark theme soft danger */
                --danger-soft-bg: hsl(0 60% 20%);
                --danger-soft-bg-hover: hsl(0 60% 24%);
                --danger-soft-bg-active: hsl(0 60% 18%);
                --danger-soft-border: hsl(0 60% 28%);
                --danger-soft-fg: hsl(0 85% 90%);
            }
        }

        /* ===== Modern UI: Overrides (non-destructive) ===== */
        body { background: var(--app-bg); color: var(--text); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        /* .container { max-width: 1600px; gap: 16px; } */
        .sidebar, .sidebar-right { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); }
        .sidebar-right-header { display: flex; justify-content: space-between; align-items: center; }
        .main-content { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); }

        .user-bar { background: var(--muted); border: 1px solid var(--border); border-radius: 10px; }
        .item { background: var(--muted); border: 1px solid var(--border); border-radius: 10px; transition: background var(--transition), border-color var(--transition), transform var(--transition); }
        .item:hover { background: color-mix(in oklab, var(--muted) 70%, var(--panel)); }
        .item.active { border-color: var(--brand); background: color-mix(in oklab, var(--brand) 8%, var(--muted)); }

        .btn { height: 36px; padding: 0 14px; border-radius: 10px; font-size: 14px; font-weight: 600; border: 1px solid transparent; transition: background var(--transition), color var(--transition), border-color var(--transition), box-shadow var(--transition); }
        .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
        .btn-primary { background: var(--brand); color: var(--brand-contrast); border-color: var(--brand); }
        .btn-primary:hover { filter: brightness(0.95); }
        .btn-secondary { background: var(--panel); color: var(--text); border-color: var(--border); }
        .btn-secondary:hover { background: var(--muted); }
        .btn-danger { background: var(--error); color: #fff; border-color: var(--error); }
        .btn-danger:hover { filter: brightness(0.95); }
        .btn-success { background: var(--success); color: #fff; border-color: var(--success); }
        .btn-success:hover { filter: brightness(0.95); }

        .chat-header { position: sticky; top: 0; backdrop-filter: saturate(150%) blur(8px); background: color-mix(in oklab, var(--panel) 92%, transparent); border-bottom: 1px solid var(--border); z-index: 10; }
        .chat-header-subtitle { color: color-mix(in oklab, var(--text) 60%, transparent); }

        .chat-messages { background: var(--muted); }
        .message-text { background: var(--bubble-bg-ai); color: var(--text); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow-sm); line-height: 1.6; }
        .message.user .message-text { background: var(--bubble-bg-user); color: var(--bubble-fg-user); border-color: color-mix(in oklab, var(--brand) 35%, var(--border)); }
        .message-bubbles { gap: 8px; }
        .message-avatar { box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
        .message-avatar[data-agent-id] { cursor: pointer; }

        .chat-input { position: sticky; bottom: 0; background: var(--panel); border-top: 1px solid var(--border); backdrop-filter: blur(6px); z-index: 10; padding: 14px 16px; }
        .chat-input textarea { background: var(--control-bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px; color: var(--text); caret-color: var(--text); color-scheme: light dark; }
        .chat-input textarea::placeholder { color: color-mix(in oklab, var(--text) 55%, transparent); }
        .chat-input textarea:disabled { background: color-mix(in oklab, var(--control-bg) 85%, transparent); color: color-mix(in oklab, var(--text) 60%, transparent); border-color: var(--border); cursor: not-allowed; }
        .chat-input textarea:disabled::placeholder { color: color-mix(in oklab, var(--text) 45%, transparent); }
        .chat-input textarea:focus-visible { outline: none; box-shadow: var(--focus-ring); border-color: var(--brand); }
        .sidebar-toggle { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; }
        .sidebar-toggle:hover { background: var(--muted); }
        .sidebar-toggle:focus-visible { outline: none; box-shadow: var(--focus-ring); }

        .typing-indicator { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow-sm); }

        .form-group input, .form-group textarea, .form-group select { background: var(--control-bg); border: 1px solid var(--border); color: var(--text); border-radius: 10px; }
        .form-group input:focus-visible, .form-group textarea:focus-visible, .form-group select:focus-visible { outline: none; box-shadow: var(--focus-ring); border-color: var(--brand); }
        .checkbox-list { border-color: var(--border); background: var(--panel); }
        .config-section { background: var(--muted); border-color: var(--border); }

        .toast { background: var(--panel); color: var(--text); border: 1px solid var(--border); box-shadow: var(--shadow-md); }
        .toast-content { color: var(--text); }
        .toast-close { color: color-mix(in oklab, var(--text) 50%, transparent); }
        .toast-close:hover { color: var(--text); }

        .message-text pre, .message-text code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .message-text pre { background: var(--control-bg); border: 1px solid var(--border); border-radius: 10px; padding: 10px; overflow: auto; }
        .message-text code { background: color-mix(in oklab, var(--muted) 60%, transparent); padding: 0 4px; border-radius: 6px; }

        @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }

        /* ===== Manual theme override (data-theme) + contrast fixes ===== */
        :root[data-theme="light"] {
            --app-bg: hsl(220 14% 97%);
            --panel: hsl(0 0% 100%);
            --text: hsl(224 71% 4%);
            --muted: hsl(220 14% 96%);
            --border: hsl(220 13% 91%);
            --control-bg: hsl(0 0% 100%);
            --bubble-bg-ai: var(--panel);
            --bubble-bg-user: color-mix(in oklab, var(--brand) 18%, var(--panel));
            --bubble-fg-user: var(--text);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 6px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);

            /* Soft danger tokens for subtle destructive actions */
            --danger-soft-bg: hsl(0 100% 97%);
            --danger-soft-bg-hover: hsl(0 100% 95%);
            --danger-soft-bg-active: hsl(0 100% 93%);
            --danger-soft-border: hsl(0 92% 88%);
            --danger-soft-fg: hsl(0 70% 30%);
        }
        :root[data-theme="dark"] {
            --app-bg: hsl(224 14% 10%);
            --panel: hsl(224 14% 12%);
            --text: hsl(0 0% 98%);
            --muted: hsl(224 14% 16%);
            --border: hsl(224 14% 22%);
            --control-bg: hsl(224 14% 16%);
            --bubble-bg-ai: hsl(224 14% 16%);
            --bubble-bg-user: color-mix(in oklab, var(--brand) 26%, var(--panel));
            --bubble-fg-user: var(--text);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.5);
            --shadow-md: 0 6px 16px rgba(0,0,0,0.55);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.6);

            /* Dark theme soft danger */
            --danger-soft-bg: hsl(0 60% 20%);
            --danger-soft-bg-hover: hsl(0 60% 24%);
            --danger-soft-bg-active: hsl(0 60% 18%);
            --danger-soft-border: hsl(0 60% 28%);
            --danger-soft-fg: hsl(0 85% 90%);
        }

        /* Contrast-safe text and surfaces */
        h2, h3, .user-info, .item-name, .message-name { color: var(--text); }
        .chat-header-info h2 { color: var(--text); }
        .modal-header h3 { color: var(--text); }
        .form-group label { color: color-mix(in oklab, var(--text) 75%, transparent); }
        .item-desc, .empty-state { color: color-mix(in oklab, var(--text) 60%, transparent); }
        .message-time, .toast-close { color: color-mix(in oklab, var(--text) 50%, transparent); }
        .modal-content { background: var(--panel); border: 1px solid var(--border); }
        .section-divider { background: var(--border); }
        .typing-indicator span { background: color-mix(in oklab, var(--text) 50%, transparent); }

        /* Header buttons fixes (override older specific styles) */
        .chat-header-actions .sidebar-toggle {
            background: var(--panel);
            color: var(--text);
            border-color: var(--border);
        }
        .chat-header-actions .sidebar-toggle:hover { background: var(--muted); }
        .chat-header-left .sidebar-toggle {
            background: var(--panel);
            color: var(--text);
            border-color: var(--border);
        }
        .chat-header-left .sidebar-toggle:hover { background: var(--muted); }
        .chat-header-actions .btn.btn-secondary { background: var(--panel); color: var(--text); border-color: var(--border); }
        .chat-header-actions .btn.btn-secondary:hover { background: var(--muted); }

        /* ===== Modal sticky header/footer overrides ===== */
        .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 85dvh;
            overflow: auto;
            padding: 0;
        }
        .modal-header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            margin: 0;
            padding: 12px 20px;
        }
        .modal-header h3 {
            margin: 0;
        }
        .modal-content form {
            flex: 1;
            overflow: auto;
            padding: 0 20px;
            margin-top: 8px;
        }
        .modal-actions {
            position: sticky;
            bottom: 0;
            z-index: 2;
            background: var(--panel);
            border-top: 1px solid var(--border);
            margin: 0;
            padding: 12px 20px;
        }
        @media (max-width: 768px) {
            .modal-content {
                max-height: 75vh;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="container">
        <div class="sidebar">
            <div class="user-bar">
                <div class="user-info">
                    👤 <span id="userNameDisplay">用户</span>
                </div>
                <button class="btn btn-secondary" id="userSettingsBtn">设置</button>
            </div>

            <h2>群聊列表</h2>
            <div class="list-container" id="groupList"></div>
            <button class="btn btn-primary" id="createGroupBtn">创建群聊</button>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="sidebar-toggle" id="toggleSidebarBtn">☰</button>
                    <div class="chat-header-info">
                        <h2 id="currentGroupName">选择一个群聊</h2>
                        <div id="groupAgents" class="chat-header-subtitle"></div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="sidebar-toggle chat-header-menu" id="toggleRightSidebarBtn" aria-label="打开右侧栏">⋮</button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="empty-state">
                    <p>👈 从左侧选择或创建一个群聊</p>
                </div>
            </div>
            <div class="chat-input">
                <textarea id="userInput" placeholder="输入消息... (Shift+Enter换行, Enter发送)" rows="2" disabled></textarea>
                <button class="btn btn-success" id="sendBtn" disabled>发送</button>
            </div>
        </div>

        <div class="sidebar-right">
            <h2 class="sidebar-right-header">
                <span>AI 角色</span>
                <button class="btn btn-secondary" id="editGroupBtn" aria-label="编辑群聊" disabled>编辑群聊</button>
            </h2>
            <div class="list-container" id="agentList"></div>
            <button class="btn btn-primary" id="createAgentBtn">创建角色</button>
            <button class="btn btn-danger" style="margin-top: 8px;" id="clearChatBtn" aria-label="清空对话" disabled>清空对话</button>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- 用户设置模态框 -->
    <div class="modal" id="userSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>用户设置</h3>
            </div>
            <form id="userSettingsForm">
                <div class="form-group">
                    <label>用户昵称 *</label>
                    <input type="text" id="userNickname" required placeholder="输入你的昵称">
                </div>
                
                <div class="section-divider"></div>
                <h3>全局 API 配置</h3>

                <div class="form-group">
                    <label>Base URL *</label>
                    <input type="text" id="globalBaseUrl" placeholder="https://api.openai.com/v1" required>
                </div>
                <div class="form-group">
                    <label>API Key *</label>
                    <input type="password" id="globalApiKey" required>
                </div>
                <div class="form-group">
                    <label>模型</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="globalModel" style="flex: 1;">
                            <option value="">-- 选择模型或点击刷新 --</option>
                            <option value="gpt-4-turbo">gpt-4-turbo</option>
                            <option value="gpt-4">gpt-4</option>
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                            <option value="gpt-3.5-turbo-16k">gpt-3.5-turbo-16k</option>
                            <option value="claude-3-opus">claude-3-opus</option>
                            <option value="claude-3-sonnet">claude-3-sonnet</option>
                            <option value="claude-3-haiku">claude-3-haiku</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="refreshModelsBtn">刷新</button>
                    </div>
                </div>

                <div class="section-divider"></div>
                <h3>系统提示显示</h3>
                <div class="form-group">
                    <label>系统提示显示级别</label>
                    <select id="systemMsgLevel">
                        <option value="all">全部</option>
                        <option value="info">信息 (info)</option>
                        <option value="success">成功 (success)</option>
                        <option value="warning">警告 (warning)</option>
                        <option value="error">错误 (error)</option>
                    </select>
                </div>

                <div class="section-divider"></div>
                <h3>外观</h3>
                <div class="form-group">
                    <label>主题模式</label>
                    <select id="themeMode">
                        <option value="system">跟随系统</option>
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelUserSettingsBtn">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 角色模态框 -->
    <div class="modal" id="agentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="agentModalTitle">创建角色</h3>
            </div>
            <form id="agentForm">
                <div class="form-group">
                    <label>角色名称 *</label>
                    <input type="text" id="agentName" required>
                </div>
                <div class="form-group">
                    <label>角色定位</label>
                    <input type="text" id="agentRole" placeholder="例如：助手、专家、顾问">
                </div>
                <div class="form-group">
                    <label>系统提示词 *</label>
                    <textarea id="agentPrompt" required placeholder="描述这个角色的性格、专长和行为方式"></textarea>
                </div>
                <div class="form-group">
                    <label>头像颜色</label>
                    <input type="color" id="agentColor" value="#667eea">
                </div>
                
                <div class="section-divider"></div>
                <h3>API 配置</h3>

                <div class="config-toggle">
                    <input type="checkbox" id="agentUseGlobal" checked>
                    <label for="agentUseGlobal" style="margin-bottom: 0;">使用全局配置</label>
                </div>

                <div class="config-section hidden" id="agentConfigSection">
                    <div class="form-group">
                        <label>Base URL *</label>
                        <input type="text" id="agentBaseUrl" placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label>API Key *</label>
                        <input type="password" id="agentApiKey">
                    </div>
                    <div class="form-group">
                        <label>模型</label>
                        <div style="display:flex; gap:10px;">
                            <select id="agentModel" style="flex:1;">
                                <option value="">-- 选择模型 --</option>
                                <option value="gpt-4-turbo">gpt-4-turbo</option>
                                <option value="gpt-4">gpt-4</option>
                                <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                <option value="gpt-3.5-turbo-16k">gpt-3.5-turbo-16k</option>
                                <option value="claude-3-opus">claude-3-opus</option>
                                <option value="claude-3-sonnet">claude-3-sonnet</option>
                                <option value="claude-3-haiku">claude-3-haiku</option>
                            </select>
                            <button type="button" class="btn btn-secondary" id="agentRefreshModelsBtn">刷新</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Temperature (0-2)</label>
                        <input type="number" id="agentTemperature" min="0" max="2" step="0.1" value="0.7">
                    </div>
                    <div class="form-group">
                        <label>Max Tokens</label>
                        <input type="number" id="agentMaxTokens" min="1" max="32000" value="2000">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAgentModalBtn">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 群聊模态框 -->
    <div class="modal" id="groupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="groupModalTitle">创建群聊</h3>
            </div>
            <form id="groupForm">
                <div class="form-group">
                    <label>群聊名称 *</label>
                    <input type="text" id="groupName" required>
                </div>
                <div class="form-group">
                    <label>群聊描述</label>
                    <textarea id="groupDesc" placeholder="描述这个群聊的用途"></textarea>
                </div>
                <div class="form-group">
                    <label>选择参与的 AI 角色 *</label>
                    <div class="checkbox-list" id="agentCheckboxList"></div>
                </div>
                <div class="form-group checkbox-inline">
                    <label for="groupAutoReply">
                        <input type="checkbox" id="groupAutoReply" checked>
                        <span>自动回复</span>
                    </label>
                </div>
                <div class="form-group" id="groupAutoReplyModeWrap">
                    <label>自动回复模式</label>
                    <select id="groupAutoReplyMode">
                        <option value="round_robin">轮流固定</option>
                        <option value="random">随机</option>
                        <option value="ai_selector">AI 决定（参考上下文）</option>
                    </select>
                </div>
                <div class="form-group" id="groupSelectorModelWrap" style="display:none;">
                    <label>选择器模型</label>
                    <div style="display:flex; gap:10px;">
                        <select id="groupSelectorModel" style="flex:1;">
                            <option value="">-- 选择模型或点击刷新 --</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="groupSelectorRefreshModelsBtn">刷新</button>
                    </div>
                </div>
                <div class="form-group" id="groupMaxRoundsWrap">
                    <label>最大自动回复轮数</label>
                    <input type="number" id="groupMaxRounds" min="1" max="20" value="5">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelGroupModalBtn">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        const qs = (s, r=document) => r.querySelector(s);
        const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));

        let OpenAI;
        
        async function loadOpenAI() {
            if (!OpenAI) {
                const module = await import('https://cdn.jsdelivr.net/npm/openai@6.4.0/+esm');
                OpenAI = module.default;
            }
            return OpenAI;
        }

        let agents = [];
        let groups = [];
        let currentGroupId = null;
        let currentEditingAgent = null;
        let currentEditingGroup = null;
        const ALL_AGENTS_GROUP_ID = 'all_agents_group';
        let globalSettings = {
            userName: '用户',
            baseUrl: 'https://api.openai.com/v1',
            apiKey: '',
            model: 'gpt-3.5-turbo',
            models: [],
            systemMsgLevel: 'all',
            themeMode: 'system'
        };

        let openaiClients = {};

        const el = {
            userSettingsBtn: qs('#userSettingsBtn'),
            cancelUserSettingsBtn: qs('#cancelUserSettingsBtn'),
            userSettingsForm: qs('#userSettingsForm'),
            userNickname: qs('#userNickname'),
            globalBaseUrl: qs('#globalBaseUrl'),
            globalApiKey: qs('#globalApiKey'),
            globalModel: qs('#globalModel'),
            refreshModelsBtn: qs('#refreshModelsBtn'),
            agentRefreshModelsBtn: qs('#agentRefreshModelsBtn'),
            userSettingsModal: qs('#userSettingsModal'),
            systemMsgLevel: qs('#systemMsgLevel'),
            themeMode: qs('#themeMode'),
            
            createGroupBtn: qs('#createGroupBtn'),
            cancelGroupModalBtn: qs('#cancelGroupModalBtn'),
            groupForm: qs('#groupForm'),
            groupName: qs('#groupName'),
            groupDesc: qs('#groupDesc'),
            groupAutoReply: qs('#groupAutoReply'),
            groupAutoReplyMode: qs('#groupAutoReplyMode'),
            groupAutoReplyModeWrap: qs('#groupAutoReplyModeWrap'),
            groupSelectorModelWrap: qs('#groupSelectorModelWrap'),
            groupSelectorModel: qs('#groupSelectorModel'),
            groupSelectorRefreshModelsBtn: qs('#groupSelectorRefreshModelsBtn'),
            groupMaxRounds: qs('#groupMaxRounds'),
            groupMaxRoundsWrap: qs('#groupMaxRoundsWrap'),
            agentCheckboxList: qs('#agentCheckboxList'),
            groupModal: qs('#groupModal'),
            groupModalTitle: qs('#groupModalTitle'),
            groupList: qs('#groupList'),
            
            createAgentBtn: qs('#createAgentBtn'),
            cancelAgentModalBtn: qs('#cancelAgentModalBtn'),
            agentForm: qs('#agentForm'),
            agentName: qs('#agentName'),
            agentRole: qs('#agentRole'),
            agentPrompt: qs('#agentPrompt'),
            agentColor: qs('#agentColor'),
            agentUseGlobal: qs('#agentUseGlobal'),
            agentConfigSection: qs('#agentConfigSection'),
            agentBaseUrl: qs('#agentBaseUrl'),
            agentApiKey: qs('#agentApiKey'),
            agentModel: qs('#agentModel'),
            agentTemperature: qs('#agentTemperature'),
            agentMaxTokens: qs('#agentMaxTokens'),
            agentModal: qs('#agentModal'),
            agentModalTitle: qs('#agentModalTitle'),
            agentList: qs('#agentList'),
            
            toggleSidebarBtn: qs('#toggleSidebarBtn'),
            themeToggleBtn: qs('#themeToggleBtn'),
            toggleRightSidebarBtn: qs('#toggleRightSidebarBtn'),
            editGroupBtn: qs('#editGroupBtn'),
            clearChatBtn: qs('#clearChatBtn'),
            currentGroupName: qs('#currentGroupName'),
            groupAgents: qs('#groupAgents'),
            chatMessages: qs('#chatMessages'),
            userInput: qs('#userInput'),
            sendBtn: qs('#sendBtn'),
            toastContainer: qs('#toastContainer'),
            userNameDisplay: qs('#userNameDisplay'),
            sidebarOverlay: qs('#sidebarOverlay')
        };

        function showToast(message, type = 'info', duration = 3000, action) {
            const container = el.toastContainer;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '✓',
                error: '✕',
                info: 'ℹ',
                warning: '⚠'
            };

            const hasAction = action && typeof action.onClick === 'function' && action.text;
            const actionHtml = hasAction ? `<button class="btn btn-secondary" data-toast-action="action">${action.text}</button>` : '';

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'ℹ'}</span>
                <div class="toast-content">${message}</div>
                ${actionHtml}
                <button class="toast-close" aria-label="关闭" onclick="this.parentElement.remove()">✕</button>
            `;

            container.appendChild(toast);

            let timerId = null;
            if (duration > 0) {
                timerId = setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('removing');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }

            if (hasAction) {
                const btn = toast.querySelector('[data-toast-action="action"]');
                if (btn) {
                    btn.addEventListener('click', () => {
                        try { action.onClick(); } finally {
                            if (timerId) clearTimeout(timerId);
                            if (toast.parentElement) toast.remove();
                        }
                    });
                }
            }
        }

        function init() {
            loadData();
            ensureAllAgentsGroup();
            initTheme();
            renderAgents();
            renderGroups();
            autoEnterLastGroup();
            autoSelectFirstGroupIfNone();
            updateUserDisplay();
            initOpenAI().catch(e => console.error('初始化 OpenAI 客户端失败:', e));
            setupEventListeners();
        }

        function loadData() {
            const savedAgents = localStorage.getItem('agents_v3');
            const savedGroups = localStorage.getItem('groups_v3');
            const savedSettings = localStorage.getItem('globalSettings_v3');

            if (savedAgents) agents = JSON.parse(savedAgents);
            if (savedGroups) groups = JSON.parse(savedGroups);
            if (savedSettings) globalSettings = JSON.parse(savedSettings);
            if (!globalSettings.systemMsgLevel) {
                globalSettings.systemMsgLevel = 'all';
            }
        }

        function saveData() {
            localStorage.setItem('agents_v3', JSON.stringify(agents));
            localStorage.setItem('groups_v3', JSON.stringify(groups));
            localStorage.setItem('globalSettings_v3', JSON.stringify(globalSettings));
        }

        function ensureAllAgentsGroup() {
            try {
                let allGroup = groups.find(g => g.isAllAgentsGroup === true || g.id === ALL_AGENTS_GROUP_ID);
                const allIds = Array.from(new Set(agents.map(a => a.id)));
                if (!allGroup) {
                    allGroup = {
                        id: ALL_AGENTS_GROUP_ID,
                        name: '所有角色群',
                        desc: '包含全部角色',
                        agentIds: allIds,
                        autoReply: false,
                        autoReplyMode: 'round_robin',
                        maxRounds: 5,
                        isAllAgentsGroup: true,
                        messages: []
                    };
                    groups.unshift(allGroup);
                    saveData();
                } else {
                    allGroup.isAllAgentsGroup = true;
                    allGroup.agentIds = allIds;
                    allGroup.autoReply = false; // 禁止自动回复
                    saveData();
                }
            } catch (_) {
                // 忽略
            }
        }

        // ==== Theme control ====
        function initTheme() {
            // 迁移旧的 localStorage 'theme'（若存在）到全局设置
            try {
                const legacy = localStorage.getItem('theme');
                if (!globalSettings.themeMode && legacy) {
                    globalSettings.themeMode = legacy === 'dark' ? 'dark' : 'light';
                    saveData();
                }
            } catch (_) {}

            const mode = globalSettings.themeMode || 'system';
            applyTheme(mode);
        }

        function applyTheme(mode) {
            const root = document.documentElement;
            if (mode === 'system') {
                root.removeAttribute('data-theme');
            } else if (mode === 'light' || mode === 'dark') {
                root.setAttribute('data-theme', mode);
            }
        }

        async function initOpenAI() {
            if (!globalSettings.apiKey) return;
            
            try {
                const OpenAIClass = await loadOpenAI();
                const key = `global_${globalSettings.apiKey.slice(0, 10)}`;
                openaiClients[key] = new OpenAIClass({
                    apiKey: globalSettings.apiKey,
                    baseURL: globalSettings.baseUrl,
                    dangerouslyAllowBrowser: true
                });
            } catch (e) {
                console.error('OpenAI 初始化失败:', e);
                showToast('OpenAI 初始化失败: ' + e.message, 'error');
            }
        }

        async function getOpenAIClient(config) {
            const key = `${config.apiKey.slice(0, 10)}_${config.baseUrl}`;
            if (!openaiClients[key]) {
                try {
                    const OpenAIClass = await loadOpenAI();
                    openaiClients[key] = new OpenAIClass({
                        apiKey: config.apiKey,
                        baseURL: config.baseUrl,
                        dangerouslyAllowBrowser: true
                    });
                } catch (e) {
                    console.error('OpenAI 客户端初始化失败:', e);
                    throw e;
                }
            }
            return openaiClients[key];
        }

        async function loadModels(e) {
            if (!globalSettings.apiKey || !globalSettings.baseUrl) {
                showToast('请先配置 API Key 和 Base URL', 'warning');
                return;
            }

            try {
                const btn = e ? e.target : el.refreshModelsBtn;
                btn.disabled = true;
                btn.innerHTML = '<div class="loading-spinner"></div>';

                const client = await getOpenAIClient(globalSettings);
                const response = await client.models.list();

                const models = response.data
                    .map(m => m.id)
                    .sort((a, b) => a.localeCompare(b));
                
                globalSettings.models = models;
                saveData();
                updateModelSelects();
                
                btn.disabled = false;
                btn.textContent = '刷新';
                showToast(`成功加载 ${models.length} 个模型`, 'success');
            } catch (error) {
                const btn = e ? e.target : el.refreshModelsBtn;
                btn.disabled = false;
                btn.textContent = '刷新';
                showToast('加载模型列表失败: ' + error.message, 'error');
            }
        }

        async function loadAgentModels(e) {
            try {
                const btn = e ? e.target : el.agentRefreshModelsBtn;
                if (btn) { btn.disabled = true; btn.innerHTML = '<div class="loading-spinner"></div>'; }

                // 根据是否使用全局配置选择来源；若自定义为空则回退全局
                const useGlobal = el.agentUseGlobal?.checked !== false; // 未找到视为全局
                const baseUrl = useGlobal ? globalSettings.baseUrl : (el.agentBaseUrl?.value || globalSettings.baseUrl);
                const apiKey = useGlobal ? globalSettings.apiKey : (el.agentApiKey?.value || globalSettings.apiKey);
                if (!apiKey || !baseUrl) {
                    if (btn) { btn.disabled = false; btn.textContent = '刷新'; }
                    showToast('请先填写可用的 API Key 和 Base URL', 'warning');
                    return;
                }

                const client = await getOpenAIClient({ baseUrl, apiKey });
                const response = await client.models.list();
                const models = response.data.map(m => m.id).sort((a,b)=>a.localeCompare(b));

                if (el.agentModel) {
                    const currentValue = el.agentModel.value;
                    el.agentModel.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                    if (currentValue) {
                        el.agentModel.value = currentValue;
                        if (el.agentModel.value !== currentValue) {
                            const opt = document.createElement('option');
                            opt.value = currentValue;
                            opt.textContent = currentValue;
                            el.agentModel.appendChild(opt);
                            el.agentModel.value = currentValue;
                        }
                    }
                }

                if (btn) { btn.disabled = false; btn.textContent = '刷新'; }
                showToast(`成功加载 ${models.length} 个模型`, 'success');
            } catch (error) {
                const btn = e ? e.target : el.agentRefreshModelsBtn;
                if (btn) { btn.disabled = false; btn.textContent = '刷新'; }
                showToast('加载模型列表失败: ' + error.message, 'error');
            }
        }

        function updateModelSelects() {
            const defaultModels = [
                { value: '', text: '-- 选择模型或点击刷新 --' },
                { value: 'gpt-4-turbo', text: 'gpt-4-turbo' },
                { value: 'gpt-4', text: 'gpt-4' },
                { value: 'gpt-3.5-turbo', text: 'gpt-3.5-turbo' },
                { value: 'gpt-3.5-turbo-16k', text: 'gpt-3.5-turbo-16k' },
                { value: 'claude-3-opus', text: 'claude-3-opus' },
                { value: 'claude-3-sonnet', text: 'claude-3-sonnet' },
                { value: 'claude-3-haiku', text: 'claude-3-haiku' }
            ];

            [el.globalModel, el.agentModel].forEach(select => {
                const currentValue = select.value;
                let options = '';
                
                if (globalSettings.models && globalSettings.models.length > 0) {
                    options = globalSettings.models
                        .map(model => `<option value="${model}">${model}</option>`)
                        .join('');
                } else {
                    options = defaultModels
                        .map(m => `<option value="${m.value}">${m.text}</option>`)
                        .join('');
                }
                
                select.innerHTML = options;
                if (currentValue) {
                    select.value = currentValue;
                    if (select.value !== currentValue) {
                        const opt = document.createElement('option');
                        opt.value = currentValue;
                        opt.textContent = currentValue;
                        select.appendChild(opt);
                        select.value = currentValue;
                    }
                }
            });
        }

        function setupEventListeners() {
            el.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            el.userSettingsBtn.addEventListener('click', openUserSettingsModal);
            el.cancelUserSettingsBtn.addEventListener('click', closeUserSettingsModal);
            el.userSettingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveUserSettings();
            });

            el.createGroupBtn.addEventListener('click', openGroupModal);
            el.cancelGroupModalBtn.addEventListener('click', closeGroupModal);
            el.groupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveGroup();
            });
            el.groupAutoReply.addEventListener('change', updateGroupAutoReplyUI);
            if (el.groupAutoReplyMode) el.groupAutoReplyMode.addEventListener('change', updateGroupAutoReplyUI);
            if (el.groupSelectorRefreshModelsBtn) el.groupSelectorRefreshModelsBtn.addEventListener('click', loadSelectorModels);

            el.createAgentBtn.addEventListener('click', openAgentModal);
            el.cancelAgentModalBtn.addEventListener('click', closeAgentModal);
            el.agentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveAgent();
            });

            el.agentUseGlobal.addEventListener('change', toggleAgentConfig);
            el.refreshModelsBtn.addEventListener('click', loadModels);
            if (el.agentRefreshModelsBtn) el.agentRefreshModelsBtn.addEventListener('click', loadAgentModels);

            el.toggleSidebarBtn.addEventListener('click', toggleSidebar);
            el.toggleRightSidebarBtn.addEventListener('click', toggleRightSidebar);
            el.editGroupBtn.addEventListener('click', editCurrentGroup);
            el.clearChatBtn.addEventListener('click', clearChat);
            el.sendBtn.addEventListener('click', sendMessage);
            el.sendBtn.addEventListener('mousedown', e => {
                e.preventDefault(); // 阻止点击时让 input 失焦
            });

            // 聊天区头像点击：打开对应角色编辑（仅 assistant 消息头像带有 data-agent-id）
            el.chatMessages.addEventListener('click', (e) => {
                const avatar = e.target.closest('.message-avatar[data-agent-id]');
                if (!avatar) return;
                const id = avatar.getAttribute('data-agent-id');
                const idx = agents.findIndex(a => a.id === id);
                if (idx !== -1) editAgent(idx);
            });

            el.agentList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('[data-action="delete-agent"]');
                const removeBtn = e.target.closest('[data-action="remove-from-group"]');
                if (deleteBtn) {
                    e.stopPropagation();
                    deleteAgent(parseInt(deleteBtn.dataset.index));
                    return;
                }
                if (removeBtn) {
                    e.stopPropagation();
                    removeAgentFromCurrentGroup(removeBtn.dataset.agentId);
                    return;
                }
                const item = e.target.closest('.agent-item');
                if (item) {
                    const id = item.getAttribute('data-agent-id');
                    const idx = agents.findIndex(a => a.id === id);
                    if (idx !== -1) editAgent(idx);
                }
            });

            el.groupList.addEventListener('click', (e) => {
                const moreBtn = e.target.closest('[data-action="group-more"]');
                if (moreBtn) {
                    e.stopPropagation();
                    const idx = moreBtn.dataset.index;
                    qsa('.dropdown-menu').forEach(m => m.classList.remove('open'));
                    const menu = qs(`.dropdown-menu[data-menu-for="${idx}"]`);
                    if (menu) menu.classList.toggle('open');
                    return;
                }

                const editBtn = e.target.closest('[data-action="edit-group"]');
                const delBtn = e.target.closest('[data-action="delete-group"]');
                if (editBtn || delBtn) {
                    e.stopPropagation();
                    qsa('.dropdown-menu').forEach(m => m.classList.remove('open'));
                }
                const item = e.target.closest('.item[data-group-id]');
                
                if (editBtn) editGroup(parseInt(editBtn.dataset.index));
                else if (delBtn) deleteGroup(parseInt(delBtn.dataset.index));
                else if (item) {
                    selectGroup(item.dataset.groupId);
                    // 移动端点击后隐藏左侧抽屉
                    if (isMobileView()) {
                        const leftSidebar = qs('.sidebar');
                        if (leftSidebar && !leftSidebar.classList.contains('hidden')) {
                            leftSidebar.classList.add('hidden');
                            localStorage.setItem('sidebarHidden', 'true');
                            updateMobileSidebarState();
                        }
                    }
                }
            });

            if (el.sidebarOverlay) {
                el.sidebarOverlay.addEventListener('click', closeMobileSidebars);
            }

            // 通用：点击模态框空白区域关闭（适用于所有 .modal.active）
            document.addEventListener('click', (ev) => {
                const actives = qsa('.modal.active');
                if (!actives.length) return;
                const top = actives[actives.length - 1];
                if (!top.contains(ev.target)) return; // 点击不在该模态内，忽略
                const content = top.querySelector('.modal-content');
                if (content && !content.contains(ev.target)) {
                    top.classList.remove('active');
                }
            });

            // 点击空白处关闭更多菜单
            document.addEventListener('click', (ev) => {
                const isMore = ev.target.closest('.more-wrap');
                if (!isMore) qsa('.dropdown-menu').forEach(m => m.classList.remove('open'));
            });

            document.addEventListener('keydown', handleGlobalKeydown);
            window.addEventListener('resize', () => { updateMobileSidebarState(); updateDesktopPushState(); });
        }

        function updateUserDisplay() {
            el.userNameDisplay.textContent = globalSettings.userName;
        }

        function openUserSettingsModal() {
            el.userNickname.value = globalSettings.userName;
            el.globalBaseUrl.value = globalSettings.baseUrl;
            el.globalApiKey.value = globalSettings.apiKey;
            el.globalModel.value = globalSettings.model;
            updateModelSelects();
            if (el.systemMsgLevel) {
                el.systemMsgLevel.value = globalSettings.systemMsgLevel || 'all';
            }
            if (el.themeMode) {
                el.themeMode.value = globalSettings.themeMode || 'system';
            }
            el.userSettingsModal.classList.add('active');
        }

        function closeUserSettingsModal() {
            el.userSettingsModal.classList.remove('active');
        }

        async function saveUserSettings() {
            globalSettings.userName = el.userNickname.value;
            globalSettings.baseUrl = el.globalBaseUrl.value;
            globalSettings.apiKey = el.globalApiKey.value;
            globalSettings.model = el.globalModel.value;
            if (el.systemMsgLevel) {
                globalSettings.systemMsgLevel = el.systemMsgLevel.value || 'all';
            }
            if (el.themeMode) {
                globalSettings.themeMode = el.themeMode.value || 'system';
            }

            saveData();
            updateUserDisplay();
            await initOpenAI();
            closeUserSettingsModal();
            showToast('设置已保存', 'success');
            if (currentGroupId) {
                renderMessages();
            }

            // 应用主题（包括跟随系统）
            applyTheme(globalSettings.themeMode || 'system');
        }

        function renderAgents() {
            const group = groups.find(g => g.id === currentGroupId);
            const list = group ? agents.filter(a => (group.agentIds || []).includes(a.id)) : [];

            if (!group) {
                el.agentList.innerHTML = '<div class="empty-state"><p>先选择一个群聊</p></div>';
                return;
            }

            if (list.length === 0) {
                el.agentList.innerHTML = '<div class="empty-state"><p>该群聊暂无角色</p></div>';
                return;
            }

            const isAll = group.isAllAgentsGroup === true;
            el.agentList.innerHTML = list.map((agent) => {
                const config = resolveAgentConfig(agent, globalSettings);
                const idx = agents.findIndex(a => a.id === agent.id);
                const actions = isAll
                    ? `<button class="icon-btn icon-btn-danger" title="删除" aria-label="删除" data-action="delete-agent" data-index="${idx}">🗑️</button>`
                    : `<button class="icon-btn icon-btn-danger" title="移除" aria-label="移除" data-action="remove-from-group" data-agent-id="${agent.id}">🗑️</button>`;
                return `
                    <div class="item agent-item" data-agent-id="${agent.id}">
                        <div class="item-header">
                            <div class="item-name">
                                <span class="agent-color" style="background: ${agent.color}"></span>
                                ${agent.name} ${agent.role ? `<span class=\"role-muted\">${agent.role}</span>` : ''}
                            </div>
                            <div class="item-actions" style="margin-top:0;">${actions}</div>
                        </div>
                        <div class="item-desc" style="font-size: 11px;">模型: ${config.model || 'gpt-3.5-turbo'}</div>
                    </div>
                `;
            }).join('');
        }

        function renderGroups() {
            if (groups.length === 0) {
                el.groupList.innerHTML = '<div class="empty-state"><p>还没有群聊<br>点击下方创建</p></div>';
                return;
            }

            el.groupList.innerHTML = groups.map((group, index) => {
                const groupAgents = group.agentIds.map(id => agents.find(a => a.id === id)).filter(a => a);
                const isAll = group.isAllAgentsGroup === true;
                const participants = (groupAgents.length + 1);
                const more = isAll ? '' : `
                    <div class="more-wrap">
                        <button class="icon-btn" data-action="group-more" data-index="${index}" aria-label="更多"><span style="font-size: 4px;">🔘 🔘 🔘</span></button>
                        <div class="dropdown-menu" data-menu-for="${index}">
                            <div class="dropdown-item" data-action="edit-group" data-index="${index}">编辑</div>
                            <div class="dropdown-item dropdown-item-danger" data-action="delete-group" data-index="${index}">删除</div>
                        </div>
                    </div>`;
                return `
                    <div class="item ${currentGroupId === group.id ? 'active' : ''}" data-group-id="${group.id}">
                        <div class="item-header">
                            <div class="item-name">${group.name} <span class="role-muted">(${participants})</span></div>
                            ${more}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMessages() {
            const group = groups.find(g => g.id === currentGroupId);
            
            if (!group || !group.messages || group.messages.length === 0) {
                el.chatMessages.innerHTML = '<div class="empty-state"><p>还没有消息<br>开始对话吧！</p></div>';
                return;
            }

            el.chatMessages.innerHTML = group.messages.map(msg => {
                if (msg.role === 'system') {
                    const lvl = msg.level || 'info';
                    const sel = globalSettings.systemMsgLevel || 'all';
                    if (sel !== 'all' && lvl !== sel) return '';
                    return `
                        <div class="system-message system-${lvl}">
                            ${escapeHtml(msg.content)}
                        </div>
                    `;
                }
                const isUser = msg.role === 'user';
                const agent = isUser ? null : agents.find(a => a.id === msg.agentId);
                const color = isUser ? '#667eea' : (agent ? agent.color : '#999');
                const name = isUser ? globalSettings.userName : (agent ? agent.name : '未知');
                const contentHTML = isUser
                    ? `<div class="message-text">${escapeHtml(msg.content)}</div>`
                    : renderGroupedBubbles(msg.content);
                const dataAgentAttr = (!isUser && agent) ? `data-agent-id="${agent.id}"` : '';
                
                return `
                    <div class="message ${isUser ? 'user' : ''}">
                        <div class="message-avatar" ${dataAgentAttr} style="background: ${color}">
                            ${name.charAt(0).toUpperCase()}
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-name">${name}</span>
                                <span class="message-time">${formatTime(msg.timestamp)}</span>
                            </div>
                            ${contentHTML}
                        </div>
                    </div>
                `;
            }).join('');
            
            el.chatMessages.scrollTop = el.chatMessages.scrollHeight;
        }

        // 将一段文本按“空行分段”，代码块 (``` ... ```) 内不拆分
        function splitIntoParagraphs(text) {
            const lines = (text || '').replace(/\r\n/g, '\n').split('\n');
            const out = [];
            let buf = [];
            let inFence = false;
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('```')) {
                    inFence = !inFence;
                    buf.push(line);
                    continue;
                }
                buf.push(line);
                if (!inFence && trimmed === '') {
                    out.push(buf.join('\n').trimEnd());
                    buf = [];
                }
            }
            if (buf.length) out.push(buf.join('\n').trimEnd());
            return out.filter(p => p.trim() !== '');
        }

        function renderGroupedBubbles(text) {
            const paras = splitIntoParagraphs(text);
            const html = paras.map(p => `<div class="message-text">${escapeHtml(p)}</div>`).join('');
            return `<div class="message-bubbles">${html || '<div class="message-text"></div>'}</div>`;
        }

        function selectGroup(groupId) {
            currentGroupId = groupId;
            const group = groups.find(g => g.id === groupId);
            
            if (!group) return;

            // 记住上次进入的群聊
            localStorage.setItem('lastGroupId_v1', groupId);

            const groupAgents = group.agentIds.map(id => agents.find(a => a.id === id)).filter(a => a);
            
            el.currentGroupName.textContent = group.name + `(${groupAgents.length + 1})`;
            const participantNames = [globalSettings.userName, ...groupAgents.map(a => a.name)];
            el.groupAgents.textContent = `参与者: ${participantNames.join(', ')}`;
            el.userInput.disabled = false;
            el.sendBtn.disabled = false;
            el.editGroupBtn.disabled = !!group.isAllAgentsGroup;
            el.clearChatBtn.disabled = false;
            
            renderGroups();
            renderMessages();
            renderAgents();
        }

        function openAgentModal() {
            currentEditingAgent = null;
            el.agentModalTitle.textContent = '创建角色';
            el.agentForm.reset();
            el.agentColor.value = generateRandomColor();
            el.agentUseGlobal.checked = true;
            toggleAgentConfig();
            el.agentModel.value = globalSettings.model;
            setAgentConfigPlaceholders();
            el.agentModal.classList.add('active');
        }

        function closeAgentModal() {
            el.agentModal.classList.remove('active');
        }

        function toggleAgentConfig() {
            const useGlobal = el.agentUseGlobal.checked;
            
            if (useGlobal) {
                el.agentConfigSection.classList.add('hidden');
            } else {
                el.agentConfigSection.classList.remove('hidden');
            }
            setAgentConfigPlaceholders();
        }

        function editAgent(index) {
            currentEditingAgent = index;
            const agent = agents[index];
            el.agentModalTitle.textContent = '编辑角色';
            el.agentName.value = agent.name;
            el.agentRole.value = agent.role || '';
            el.agentPrompt.value = agent.prompt;
            el.agentColor.value = agent.color;
            el.agentUseGlobal.checked = agent.useGlobal !== false;
            toggleAgentConfig();
            
            if (!agent.useGlobal) {
                el.agentBaseUrl.value = agent.baseUrl || '';
                el.agentApiKey.value = agent.apiKey || '';
                el.agentTemperature.value = agent.temperature || 0.7;
                el.agentMaxTokens.value = agent.maxTokens || 2000;
            }
            el.agentModel.value = agent.model || globalSettings.model;
            setAgentConfigPlaceholders();
            el.agentModal.classList.add('active');
        }

        function saveAgent() {
            const useGlobal = el.agentUseGlobal.checked;
            
            const agent = {
                id: currentEditingAgent !== null ? agents[currentEditingAgent].id : generateId(),
                name: el.agentName.value,
                role: el.agentRole.value,
                prompt: el.agentPrompt.value,
                color: el.agentColor.value,
                useGlobal: useGlobal,
                model: el.agentModel.value || globalSettings.model
            };

            if (!useGlobal) {
                if (el.agentBaseUrl.value) agent.baseUrl = el.agentBaseUrl.value;
                if (el.agentApiKey.value) agent.apiKey = el.agentApiKey.value;
                if (el.agentTemperature.value !== '') agent.temperature = parseFloat(el.agentTemperature.value);
                if (el.agentMaxTokens.value !== '') agent.maxTokens = parseInt(el.agentMaxTokens.value);
            }

            if (currentEditingAgent !== null) {
                agents[currentEditingAgent] = agent;
            } else {
                agents.push(agent);
                const allGroup = groups.find(g => g.isAllAgentsGroup);
                if (allGroup) {
                    if (!Array.isArray(allGroup.agentIds)) allGroup.agentIds = [];
                    if (!allGroup.agentIds.includes(agent.id)) allGroup.agentIds.push(agent.id);
                }
                if (currentGroupId) {
                    const curr = groups.find(g => g.id === currentGroupId);
                    if (curr) {
                        if (!Array.isArray(curr.agentIds)) curr.agentIds = [];
                        if (!curr.agentIds.includes(agent.id)) curr.agentIds.push(agent.id);
                    }
                }
            }

            ensureAllAgentsGroup();
            saveData();
            renderAgents();
            renderGroups();
            if (currentGroupId) renderMessages();
            closeAgentModal();
        }

        function deleteAgent(index) {
            const removed = agents[index];
            if (!removed) return;
            const agentId = removed.id;
            const originalIndex = index;
            const affectedGroups = groups
                .filter(g => Array.isArray(g.agentIds) && g.agentIds.includes(agentId))
                .map(g => g.id);

            agents.splice(index, 1);
            groups.forEach(group => {
                group.agentIds = (group.agentIds || []).filter(id => id !== agentId);
            });

            saveData();
            renderAgents();
            renderGroups();
            if (currentGroupId) renderMessages();

            let undone = false;
            const undo = () => {
                if (undone) return; undone = true;
                const insertAt = Math.min(originalIndex, agents.length);
                agents.splice(insertAt, 0, removed);
                groups.forEach(group => {
                    if (affectedGroups.includes(group.id)) {
                        if (!group.agentIds) group.agentIds = [];
                        if (!group.agentIds.includes(agentId)) group.agentIds.push(agentId);
                    }
                });
                saveData();
                renderAgents();
                renderGroups();
                if (currentGroupId) renderMessages();
                showToast('已撤销删除', 'info', 3000);
            };

            showToast('删除成功', 'success', 6000, { text: '撤销', onClick: undo });
        }

        function removeAgentFromCurrentGroup(agentId) {
            if (!currentGroupId) return;
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;
            if (!Array.isArray(group.agentIds)) group.agentIds = [];
            if (!group.agentIds.includes(agentId)) return;

            const prev = group.agentIds.slice();
            group.agentIds = group.agentIds.filter(id => id !== agentId);
            saveData();
            renderAgents();
            renderGroups();
            if (currentGroupId) renderMessages();

            let undone = false;
            const undo = () => {
                if (undone) return; undone = true;
                group.agentIds = prev;
                saveData();
                renderAgents();
                renderGroups();
                if (currentGroupId) renderMessages();
                showToast('已撤销移除', 'info', 3000);
            };
            showToast('已从当前群聊移除', 'success', 6000, { text: '撤销', onClick: undo });
        }

        function openGroupModal() {
            if (agents.length === 0) {
                showToast('请先创建至少一个角色', 'warning');
                return;
            }

            currentEditingGroup = null;
            el.groupModalTitle.textContent = '创建群聊';
            el.groupForm.reset();
            el.groupAutoReply.checked = true;
            el.groupMaxRounds.value = '5';
            if (el.groupAutoReplyMode) el.groupAutoReplyMode.value = 'round_robin';
            if (el.groupSelectorModel) {
                updateSelectorModelSelect();
                el.groupSelectorModel.value = globalSettings.model || '';
            }
            renderAgentCheckboxes();
            updateGroupAutoReplyUI();
            el.groupModal.classList.add('active');
        }

        function closeGroupModal() {
            el.groupModal.classList.remove('active');
        }

        function editCurrentGroup() {
            if (!currentGroupId) return;
            const index = groups.findIndex(g => g.id === currentGroupId);
            if (index !== -1 && !groups[index].isAllAgentsGroup) editGroup(index);
        }

        function editGroup(index) {
            currentEditingGroup = index;
            const group = groups[index];
            el.groupModalTitle.textContent = '编辑群聊';
            el.groupName.value = group.name;
            el.groupDesc.value = group.desc || '';
            el.groupAutoReply.checked = group.autoReply;
            el.groupMaxRounds.value = (group.maxRounds ?? 5);
            if (el.groupAutoReplyMode) el.groupAutoReplyMode.value = group.autoReplyMode || 'round_robin';
            if (el.groupSelectorModel) {
                updateSelectorModelSelect();
                el.groupSelectorModel.value = group.selectorModel || globalSettings.model || '';
                if (el.groupSelectorModel.value !== (group.selectorModel || globalSettings.model || '')) {
                    const opt = document.createElement('option');
                    opt.value = group.selectorModel || globalSettings.model || '';
                    opt.textContent = group.selectorModel || globalSettings.model || '';
                    el.groupSelectorModel.appendChild(opt);
                    el.groupSelectorModel.value = group.selectorModel || globalSettings.model || '';
                }
            }
            renderAgentCheckboxes(group.agentIds);
            updateGroupAutoReplyUI();
            el.groupModal.classList.add('active');
        }

        function renderAgentCheckboxes(selectedIds = []) {
            el.agentCheckboxList.innerHTML = agents.map(agent => `
                <div class="checkbox-item">
                    <input type="checkbox" id="agent_${agent.id}" value="${agent.id}" 
                        ${selectedIds.includes(agent.id) ? 'checked' : ''}>
                    <label for="agent_${agent.id}" style="margin-bottom: 0;">
                        <span class="agent-color" style="background: ${agent.color}"></span>
                        ${agent.name} | ${agent.role || 'No Role'}
                    </label>
                </div>
            `).join('');
        }

        function saveGroup() {
            const selectedAgentIds = Array.from(qsa('#agentCheckboxList input:checked'))
                .map(input => input.value);

            if (selectedAgentIds.length === 0) {
                showToast('请至少选择一个角色', 'warning');
                return;
            }

            const group = {
                id: currentEditingGroup !== null ? groups[currentEditingGroup].id : generateId(),
                name: el.groupName.value,
                desc: el.groupDesc.value,
                agentIds: selectedAgentIds,
                autoReply: el.groupAutoReply.checked,
                autoReplyMode: el.groupAutoReplyMode ? el.groupAutoReplyMode.value : 'round_robin',
                maxRounds: parseInt(el.groupMaxRounds.value),
                selectorModel: (el.groupAutoReplyMode && el.groupAutoReplyMode.value === 'ai_selector') ? (el.groupSelectorModel?.value || '') : (groups[currentEditingGroup]?.selectorModel || ''),
                messages: currentEditingGroup !== null ? groups[currentEditingGroup].messages : []
            };

            if (currentEditingGroup !== null) {
                groups[currentEditingGroup] = group;
            } else {
                groups.push(group);
            }

            saveData();
            renderGroups();
            autoSelectFirstGroupIfNone();
            if (currentGroupId === group.id) selectGroup(group.id);
            closeGroupModal();
        }

        function deleteGroup(index) {
            const removed = groups[index];
            if (!removed) return;
            const groupId = removed.id;
            const originalIndex = index;
            const wasCurrent = currentGroupId === groupId;
            const hadLast = localStorage.getItem('lastGroupId_v1') === groupId;

            groups.splice(index, 1);

            if (wasCurrent) {
                currentGroupId = null;
                el.currentGroupName.textContent = '选择一个群聊开始对话';
                el.groupAgents.textContent = '';
                el.userInput.disabled = true;
                el.sendBtn.disabled = true;
                el.editGroupBtn.disabled = true;
                el.clearChatBtn.disabled = true;
                el.chatMessages.innerHTML = '<div class="empty-state"><p>👈 从左侧选择或创建一个群聊</p></div>';
            }

            if (hadLast) {
                localStorage.removeItem('lastGroupId_v1');
            }

            saveData();
            renderGroups();
            autoSelectFirstGroupIfNone();

            let undone = false;
            const undo = () => {
                if (undone) return; undone = true;
                const insertAt = Math.min(originalIndex, groups.length);
                groups.splice(insertAt, 0, removed);
                saveData();
                renderGroups();
                autoSelectFirstGroupIfNone();
                if (wasCurrent) {
                    currentGroupId = groupId;
                    selectGroup(groupId);
                }
                if (hadLast) {
                    localStorage.setItem('lastGroupId_v1', groupId);
                }
                showToast('已撤销删除', 'info', 3000);
            };

            showToast('删除成功', 'success', 6000, { text: '撤销', onClick: undo });
        }

        async function sendMessage() {
            const content = el.userInput.value.trim();
            
            if (!content || !currentGroupId) return;
            
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;

            const userMessage = {
                role: 'user',
                content: content,
                timestamp: Date.now()
            };

            if (!group.messages) group.messages = [];
            group.messages.push(userMessage);
            el.userInput.value = '';
            saveData();
            renderMessages();

            if (group.isAllAgentsGroup) {
                return;
            }

            if (group.autoReply) {
                const mode = group.autoReplyMode || 'round_robin';
                if (mode === 'round_robin') {
                    await startGroupChatRoundRobin(group);
                } else if (mode === 'random') {
                    await startGroupChatRandom(group);
                } else {
                    await startGroupChatAISelector(group);
                }
            } else {
                const groupAgents = group.agentIds.map(id => agents.find(a => a.id === id)).filter(a => a);
                if (groupAgents.length > 0) {
                    await getAgentResponse(group, groupAgents[0]);
                }
            }
        }

        async function startGroupChatRoundRobin(group) {
            let rounds = 0;
            const maxRounds = group.maxRounds || 0;
            const groupAgents = group.agentIds.map(id => agents.find(a => a.id === id)).filter(a => a);

            while (rounds < maxRounds && groupAgents.length > 0) {
                const agentIndex = rounds % groupAgents.length;
                const agent = groupAgents[agentIndex];
                
                await getAgentResponse(group, agent);
                rounds++;

                if (rounds < maxRounds) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        async function startGroupChatRandom(group) {
            const maxRounds = group.maxRounds || 0;
            const groupAgents = group.agentIds.map(id => agents.find(a => a.id === id)).filter(a => a);
            if (groupAgents.length === 0) return;
            // 随机决定本轮会进行的回复次数（上限为 maxRounds，至少 1 次）
            const totalRounds = Math.max(1, Math.floor(Math.random() * Math.max(1, maxRounds)) + 1);
            let lastAgentId = null;
            for (let i = 0; i < totalRounds; i++) {
                let candidate;
                // 尽量避免连续同一角色
                const pool = groupAgents.filter(a => a.id !== lastAgentId);
                if (pool.length === 0) {
                    candidate = groupAgents[Math.floor(Math.random() * groupAgents.length)];
                } else {
                    candidate = pool[Math.floor(Math.random() * pool.length)];
                }
                await getAgentResponse(group, candidate);
                lastAgentId = candidate.id;
                if (i < totalRounds - 1) {
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        async function startGroupChatAISelector(group) {
            const candidates = group.agentIds.map(id => agents.find(a => a.id === id)).filter(a => a);
            if (candidates.length === 0) return;
            const MAX_STEPS = Math.max(1, group.maxRounds || 20); // 安全上限由用户配置决定
            for (let step = 0; step < MAX_STEPS; step++) {
                const next = await selectNextAgentByAI(group, candidates);
                if (!next || next === 'STOP') {
                    addSystemMessage(group, 'AI 决定结束对话', 'info');
                    break;
                }
                addSystemMessage(group, `AI 选择由 ${next.name} 回复`, 'info');
                await getAgentResponse(group, next);
                if (step < MAX_STEPS - 1) {
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        async function selectNextAgentByAI(group, candidates) {
            try {
                if (!globalSettings.apiKey || !globalSettings.baseUrl) {
                    showToast('请先在用户设置中配置 API Key 和 Base URL', 'warning');
                    return null;
                }
                const client = await getOpenAIClient(globalSettings);
                const candidateList = candidates.map(a => ({ name: a.name, role: a.role || '' }));
                const recent = (group.messages || []).slice(-20).filter(m => m.role !== 'system');
                const history = recent.map(m => {
                    if (m.role === 'user') return { role: 'user', content: `[${globalSettings.userName}]: ${m.content}` };
                    const msgAgent = agents.find(a => a.id === m.agentId);
                    const name = msgAgent ? msgAgent.name : '未知';
                    return { role: 'user', content: `[${name}]: ${m.content}` };
                });
                const sys = {
                    role: 'system',
                    content: `你是群聊的主持与调度者。请根据最近对话历史，从候选人中选择下一位发言者，或决定结束。
严格遵循输出格式，只能输出严格 JSON（不包含多余文本/解释/代码块标记）：{"next":"<候选名称>"} 或 {"next":"STOP"}。
候选人列表（仅可从这些名称中选择）：${JSON.stringify(candidateList)}。`
                };
                const resp = await client.chat.completions.create({
                    model: (groups.find(g=>g.id===group.id)?.selectorModel) || group.selectorModel || globalSettings.model || 'gpt-3.5-turbo',
                    temperature: 0.2,
                    max_tokens: 60,
                    messages: [sys, ...history]
                });
                const textRaw = resp.choices?.[0]?.message?.content || '';
                const text = textRaw.trim();
                let jsonStr = text;
                if (!jsonStr.startsWith('{')) {
                    const first = text.indexOf('{');
                    const last = text.lastIndexOf('}');
                    if (first !== -1 && last !== -1 && last > first) {
                        jsonStr = text.substring(first, last + 1);
                    }
                }
                let obj;
                try { obj = JSON.parse(jsonStr); } catch { return null; }
                const nextName = obj && typeof obj.next === 'string' ? obj.next : null;
                if (nextName === 'STOP') return 'STOP';
                const found = candidates.find(a => a.name === nextName);
                return found || null;
            } catch (e) {
                console.error('AI 选择器失败:', e);
                addSystemMessage(group, 'AI 选择器失败：' + (e.message || '未知错误'), 'warning');
                return null;
            }
        }

        function updateGroupAutoReplyUI() {
            const enabled = el.groupAutoReply?.checked;
            if (el.groupAutoReplyModeWrap) {
                el.groupAutoReplyModeWrap.style.display = enabled ? '' : 'none';
            }
            const mode = el.groupAutoReplyMode ? el.groupAutoReplyMode.value : 'round_robin';
            if (el.groupMaxRoundsWrap) {
                const showRounds = enabled; // 所有模式下均显示，作为安全上限
                el.groupMaxRoundsWrap.style.display = showRounds ? '' : 'none';
            }
            if (el.groupSelectorModelWrap) {
                const showSelector = enabled && mode === 'ai_selector';
                el.groupSelectorModelWrap.style.display = showSelector ? '' : 'none';
            }
        }

        function updateSelectorModelSelect() {
            if (!el.groupSelectorModel) return;
            const models = (globalSettings.models && globalSettings.models.length > 0)
                ? globalSettings.models
                : [
                    '', 'gpt-4-turbo', 'gpt-4', 'gpt-3.5-turbo', 'gpt-3.5-turbo-16k',
                    'claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku'
                  ];
            if (models[0] === '') {
                el.groupSelectorModel.innerHTML = [
                    '<option value="">-- 选择模型或点击刷新 --</option>',
                    '<option value="gpt-4-turbo">gpt-4-turbo</option>',
                    '<option value="gpt-4">gpt-4</option>',
                    '<option value="gpt-3.5-turbo">gpt-3.5-turbo</option>',
                    '<option value="gpt-3.5-turbo-16k">gpt-3.5-turbo-16k</option>',
                    '<option value="claude-3-opus">claude-3-opus</option>',
                    '<option value="claude-3-sonnet">claude-3-sonnet</option>',
                    '<option value="claude-3-haiku">claude-3-haiku</option>'
                ].join('');
            } else {
                el.groupSelectorModel.innerHTML = models.map(m=>`<option value="${m}">${m}</option>`).join('');
            }
        }

        async function loadSelectorModels(e) {
            if (!globalSettings.apiKey || !globalSettings.baseUrl) {
                showToast('请先配置 API Key 和 Base URL', 'warning');
                return;
            }
            try {
                const btn = e ? e.target : el.groupSelectorRefreshModelsBtn;
                if (btn) { btn.disabled = true; btn.innerHTML = '<div class="loading-spinner"></div>'; }
                const client = await getOpenAIClient(globalSettings);
                const response = await client.models.list();
                const models = response.data.map(m=>m.id).sort((a,b)=>a.localeCompare(b));
                globalSettings.models = models;
                saveData();
                updateSelectorModelSelect();
                if (btn) { btn.disabled = false; btn.textContent = '刷新'; }
                showToast(`成功加载 ${models.length} 个模型`, 'success');
            } catch (error) {
                const btn = e ? e.target : el.groupSelectorRefreshModelsBtn;
                if (btn) { btn.disabled = false; btn.textContent = '刷新'; }
                showToast('加载模型列表失败: ' + error.message, 'error');
            }
        }

        async function getAgentResponse(group, agent) {
            try {
                const config = resolveAgentConfig(agent, globalSettings);
                
                const historySource = group.messages.filter(m => m.role !== 'system');
                const conversationHistory = historySource.map(msg => {
                    if (msg.role === 'user') {
                        return { role: 'user', content: `[${globalSettings.userName}]: ${msg.content}` };
                    } else {
                        const msgAgent = agents.find(a => a.id === msg.agentId);
                        const agentName = msgAgent ? msgAgent.name : '未知';
                        
                        if (msg.agentId === agent.id) {
                            // 自己的历史消息保持 assistant
                            return { 
                                role: 'assistant', 
                                content: `[${agentName}]: ${msg.content}` 
                            };
                        } else {
                            // 其他 AI 的消息转为 user
                            return { 
                                role: 'user', 
                                content: `[${agentName}]: ${msg.content}` 
                            };
                        }
                    }
                });

                const otherAgents = group.agentIds
                    .map(id => agents.find(a => a.id === id))
                    .filter(a => a && a.id !== agent.id)
                    .map(a => a.name)
                    .join(', ');

                const role = `请你以你的身份自然地回复对话。禁止项: 禁止在回复里出现你的名字。
----
[输出规则] 格式纯净性 (Format Purity): 你的所有回复都必须直接以内容开始。严禁在回复的开头添加任何形式的身份标识、名称或前缀，例如 '[${agent.name}]:'、'${agent.name}:' 或 '[AI]:'。`
                conversationHistory.unshift({
                    role: 'system',
                    content: `你的名字是 ${agent.name}${agent.role ? '，' + agent.role : ''}。${agent.prompt}\n\n这是一个群聊环境，参与者包括: ${globalSettings.userName}${otherAgents ? ', ' + otherAgents : ''}。` + role
                });

                const assistantMessage = {
                    role: 'assistant',
                    agentId: agent.id,
                    content: '',
                    timestamp: Date.now()
                };
                group.messages.push(assistantMessage);
                const msgIndex = group.messages.length - 1;
                let assembled = '';
                showStreamingMessage(agent);

                const client = await getOpenAIClient(config);
                const stream = await client.chat.completions.create({
                    model: config.model,
                    messages: conversationHistory,
                    temperature: config.temperature || 0.7,
                    max_tokens: config.maxTokens || 2000,
                    stream: true
                });

                for await (const chunk of stream) {
                    let delta = chunk.choices[0]?.delta?.content;
                    let content = group.messages[msgIndex]?.content ?? '';
                    if (delta) {
                        if (content === '') {
                            delta = delta.trimStart();
                        }
                        content += delta;
                        // 清理接收到的消息中的前缀（如果AI返回了[角色名]:格式）
                        // 1. 构建正则表达式
                        //    ^           - 匹配字符串的开头
                        //    \[         - 匹配字面量 '['
                        //    ${escapedName} - 插入转义后的 agent name
                        //    \]         - 匹配字面量 ']'
                        //    [:：]       - 匹配一个字符类：半角冒号 : 或 全角冒号 ：
                        //    \s* - 匹配冒号后面的零个或多个空白字符（包括空格、制表符等）
                        // const prefixRegex = new RegExp(`^\\[${agent.name}\\][:：]\\s*`);
                        // 2. 使用 while 循环持续清理前缀
                        //    只要 content 仍然以前缀开头，就不断替换掉它
                        //    这可以处理 [Bot]: Hello 和 [Bot]: [Bot]: Hello 两种情况
                        // while (prefixRegex.test(content)) {
                        //     content = content.replace(prefixRegex, '');
                        // }
                        // const prefixPattern = `[${agent.name}]:`;
                        // if (content.startsWith(prefixPattern)) {
                        //     content = content.substring(prefixPattern.length).trimStart();
                        // }
                        assembled = content.trim();
                        if (group.messages[msgIndex]) group.messages[msgIndex].content = content;
                        updateStreamingMessage(agent, content);
                    }
                }

                removeStreamingIndicator();
                if (!assembled || assembled.trim() === '') {
                    // 空响应，不保留占位消息
                    group.messages.splice(msgIndex, 1);
                    saveData();
                    renderMessages();
                    addSystemMessage(group, `角色 ${agent.name} 未返回内容`, 'info');
                    return;
                }
                // 正常内容，保存渲染
                saveData();
                renderMessages();

            } catch (error) {
                removeStreamingIndicator();
                console.error('Error:', error);
                // 移除可能预先压入但未形成内容的消息
                const last = groups.find(g => g.id === group.id)?.messages?.slice(-1)[0];
                if (last && last.role === 'assistant' && last.agentId === agent.id && (!last.content || last.content.trim() === '')) {
                    group.messages.pop();
                }
                saveData();
                renderMessages();
                addSystemMessage(group, `角色 ${agent.name} 响应失败: ${error.message}`, 'error');
            }
        }

        // 向聊天列表插入系统提示（居中、弱化、颜色区分）
        function addSystemMessage(group, content, level = 'info') {
            if (!group) return;
            if (!group.messages) group.messages = [];
            group.messages.push({ role: 'system', content, level, timestamp: Date.now() });
            saveData();
            renderMessages();
        }

        function showStreamingMessage(agent) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message streaming';
            messageDiv.id = 'streamingMessage';
            messageDiv.innerHTML = `
                <div class="message-avatar" style="background: ${agent.color}">
                    ${agent.name.charAt(0).toUpperCase()}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-name">${agent.name}</span>
                        <span class="message-time" id="streamingTime">${formatTime(Date.now())}</span>
                    </div>
                    <div class="message-bubbles" id="streamingBubbles">
                        <div class="message-text" id="streamingBubble">
                            <span class="typing-indicator"><span></span><span></span><span></span></span>
                        </div>
                    </div>
                </div>
            `;
            el.chatMessages.appendChild(messageDiv);
            el.chatMessages.scrollTop = el.chatMessages.scrollHeight;
        }

        function updateStreamingMessage(agent, content) {
            const wrap = qs('#streamingBubbles');
            if (wrap) {
                const paras = splitIntoParagraphs(content);
                if (paras.length === 0) {
                    wrap.innerHTML = `<div class="message-text"><span class="typing-indicator"><span></span><span></span><span></span></span></div>`;
                } else {
                    wrap.innerHTML = paras.map(p => `<div class="message-text">${escapeHtml(p)}</div>`).join('');
                }
                const container = wrap.closest('.message');
                if (container && container.classList.contains('streaming') && content.trim().length > 0) {
                    container.classList.remove('streaming');
                }
                el.chatMessages.scrollTop = el.chatMessages.scrollHeight;
                return;
            }
            // 兼容旧结构
            const streamingContent = qs('#streamingContent');
            if (streamingContent) {
                streamingContent.textContent = content;
                const container = streamingContent.closest('.message');
                if (container && container.classList.contains('streaming') && content.trim().length > 0) {
                    container.classList.remove('streaming');
                }
                el.chatMessages.scrollTop = el.chatMessages.scrollHeight;
            }
        }

        function removeStreamingIndicator() {
            const indicator = qs('#streamingMessage');
            if (indicator) indicator.remove();
        }

        function clearChat() {
            if (!currentGroupId) return;
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;

            const previous = Array.isArray(group.messages) ? group.messages.slice() : [];
            group.messages = [];
            saveData();
            renderMessages();

            let undone = false;
            const undo = () => {
                if (undone) return; undone = true;
                group.messages = previous;
                saveData();
                renderMessages();
                showToast('已撤销删除', 'info', 3000);
            };

            showToast('删除成功', 'success', 6000, { text: '撤销', onClick: undo });
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generateRandomColor() {
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#30cfd0', '#a8edea', '#ff6b6b', '#4ecdc4'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // 合并 Agent 与全局配置，未填写则回退到全局
        function resolveAgentConfig(agent, global) {
            const useGlobal = agent.useGlobal !== false;
            const base = useGlobal ? {} : agent;
            return {
                baseUrl: useGlobal ? global.baseUrl : (base.baseUrl || global.baseUrl),
                apiKey: useGlobal ? global.apiKey : (base.apiKey || global.apiKey),
                model: useGlobal ? (agent.model || global.model) : (base.model || global.model),
                temperature: useGlobal ? (agent.temperature ?? 0.7) : (base.temperature ?? 0.7),
                maxTokens: useGlobal ? (agent.maxTokens ?? 2000) : (base.maxTokens ?? 2000)
            };
        }

        // 设置 Agent 配置输入的占位符/默认选项
        function setAgentConfigPlaceholders() {
            if (el.agentBaseUrl) {
                el.agentBaseUrl.placeholder = globalSettings.baseUrl || 'https://api.openai.com/v1';
            }
            if (el.agentApiKey) {
                el.agentApiKey.placeholder = '留空以使用全局 API Key';
            }
            if (el.agentModel) {
                if (!el.agentModel.value) {
                    el.agentModel.value = globalSettings.model || '';
                }
                const desired = el.agentModel.value || (globalSettings.model || '');
                if (desired) {
                    const has = Array.from(el.agentModel.options).some(o => o.value === desired);
                    if (!has) {
                        const opt = document.createElement('option');
                        opt.value = desired;
                        opt.textContent = desired;
                        el.agentModel.appendChild(opt);
                    }
                    el.agentModel.value = desired;
                }
            }
        }

        function isMobileView() {
            return window.matchMedia('(max-width: 768px)').matches;
        }

        function updateMobileSidebarState() {
            if (!el.sidebarOverlay) return;

            if (!isMobileView()) {
                el.sidebarOverlay.classList.remove('active');
                return;
            }

            const leftOpen = !qs('.sidebar').classList.contains('hidden');
            const rightOpen = !qs('.sidebar-right').classList.contains('hidden');

            if (leftOpen || rightOpen) {
                el.sidebarOverlay.classList.add('active');
            } else {
                el.sidebarOverlay.classList.remove('active');
            }
        }

        // Desktop: reflect sidebar open state by pushing main content
        function updateDesktopPushState() {
            if (isMobileView()) return;
            const container = qs('.container');
            const leftOpen = !qs('.sidebar').classList.contains('hidden');
            const rightOpen = !qs('.sidebar-right').classList.contains('hidden');
            container.classList.toggle('left-open', leftOpen);
            container.classList.toggle('right-open', rightOpen);
        }

        function closeMobileSidebars() {
            if (!isMobileView() || !el.sidebarOverlay) return;

            const leftSidebar = qs('.sidebar');
            const rightSidebar = qs('.sidebar-right');
            let changed = false;

            if (!leftSidebar.classList.contains('hidden')) {
                leftSidebar.classList.add('hidden');
                localStorage.setItem('sidebarHidden', 'true');
                changed = true;
            }

            if (!rightSidebar.classList.contains('hidden')) {
                rightSidebar.classList.add('hidden');
                localStorage.setItem('sidebarRightHidden', 'true');
                changed = true;
            }

            if (changed || el.sidebarOverlay.classList.contains('active')) {
                updateMobileSidebarState();
            }
        }

        function handleGlobalKeydown(e) {
            if (e.key === 'Escape') {
                if (closeTopModal()) {
                    e.preventDefault();
                    return;
                }
                closeMobileSidebars();
            }
        }

        function closeTopModal() {
            const actives = qsa('.modal.active');
            if (actives.length > 0) {
                const top = actives[actives.length - 1];
                top.classList.remove('active');
                return true;
            }
            return false;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function toggleSidebar() {
            const sidebar = qs('.sidebar');
            sidebar.classList.toggle('hidden');
            localStorage.setItem('sidebarHidden', sidebar.classList.contains('hidden'));
            updateMobileSidebarState();
            updateDesktopPushState();
        }

        function toggleRightSidebar() {
            const sidebarRight = qs('.sidebar-right');
            sidebarRight.classList.toggle('hidden');
            localStorage.setItem('sidebarRightHidden', sidebarRight.classList.contains('hidden'));
            updateMobileSidebarState();
            updateDesktopPushState();
        }

        function restoreSidebarState() {
            const isSidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
            const isRightSidebarHidden = localStorage.getItem('sidebarRightHidden') === 'true';
            
            if (isSidebarHidden) {
                qs('.sidebar').classList.add('hidden');
            }
            if (isRightSidebarHidden) {
                qs('.sidebar-right').classList.add('hidden');
            }

            updateMobileSidebarState();
            updateDesktopPushState();
        }

        // 若未选中任何群聊，则默认选中列表中的第一个
        function autoSelectFirstGroupIfNone() {
            if (!currentGroupId && Array.isArray(groups) && groups.length > 0) {
                selectGroup(groups[0].id);
            }
        }

        // 启动时尝试自动进入上次退出的群聊
        function autoEnterLastGroup() {
            const lastId = localStorage.getItem('lastGroupId_v1');
            if (!lastId) return;
            if (!groups || groups.length === 0) return;
            if (groups.some(g => g.id === lastId)) {
                selectGroup(lastId);
            }
        }

        init();
        restoreSidebarState();
        updateMobileSidebarState();
        updateDesktopPushState();
    </script>
</body>
</html>
